#include "uart.h"

#define GPIOAEN				(1U << 0)
#define UART2EN				(1U << 17)
#define UART2_BAUDRATE		115200
#define SYS_FREQ 			16000000
#define APB1_CLK 			SYS_FREQ
#define CR1_TE 				(1U << 3)
#define CR1_UE				(1U << 13)
#define SR_TXE				(1U << 7)

void uart_init(void)
{
	/* Enable clock access to GPIOA */
	RCC->AHB1ENR |= GPIOAEN;

	/* Set the mode of PA2 to alternate function mode */
	GPIOA->MODER &= ~(1U << 4);
	GPIOA->MODER |= (1U << 5);

	/* Set alternate function type to AF7(UART2_TX) */
	GPIOA->AFR[0] |= (1U << 8);
	GPIOA->AFR[0] |= (1U << 9);
	GPIOA->AFR[0] |= (1U << 10);
	GPIOA->AFR[0] &= ~(1U << 11);

	/* Enable clock access to UART2 */
	RCC->APB1ENR |= UART2EN;

	/* Configure uart baudrate */
	uint32_t usartdiv_mult16 = APB1_CLK / UART2_BAUDRATE;
	uint32_t mantissa = usartdiv_mult16 / 16U;
	uint32_t fractional = usartdiv_mult16 % 16U;
	USART2->BRR = (mantissa << 4) | (fractional & 0x0F);

	/* Configure transfer direction */
	USART2->CR1 = CR1_TE;

	/* Enable UART Module */
	USART2->CR1 |= CR1_UE;
}

uint8_t uart_read(void)
{
	 /* Make sure transmit data register is empty */
	 while(!(USART2->SR & SR_TXE)){}
	 /* Write to transmit data register */
	 USART2->DR =(ch & 0xFF);
}

uint8_t uart_rx(void)
{
    /* Wait until data is received (RXNE = 1) */
    while (!(USART2->SR & (1U << 5)));

    /* Read from Receive Data Register */
    return (uint8_t)(USART2->DR & 0xFF);
}

